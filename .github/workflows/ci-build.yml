name: CI

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  GHCR_ORG: avarcorg
  MATTERMOST_BOT_USERNAME: avarc-chatopts-bot  
  
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to GHCR
        run: echo ${{ secrets.GHCR_TOKEN }} | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin

      - name: Build Docker Image
        run: docker build -t ghcr.io/${{ env.GHCR_ORG }}/avarc-chatops-bot:latest .

      - name: Push Docker Image
        run: |
          echo
          docker images | grep -v "IMAGE ID" | sort
          docker push ghcr.io/${{ env.GHCR_ORG }}/avarc-chatops-bot:latest

      - name: Notify Mattermost - Success
        if: success()
        uses: mattermost/action-mattermost-notify@master
        with:
          MATTERMOST_WEBHOOK_URL: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
          MATTERMOST_CHANNEL: ${{ secrets.MATTERMOST_CHANNEL }}
          MATTERMOST_USERNAME: ${{ env.MATTERMOST_BOT_USERNAME }}
          TEXT: |
            AvArc ChatopsBot - Build successful! :rocket:
            [View build details](${{
              github.server_url }}/${{
              github.repository }}/actions/runs/${{
              github.run_id }})

      - name: Notify Mattermost - Failure
        if: failure()
        uses: mattermost/action-mattermost-notify@master
        with:
          MATTERMOST_WEBHOOK_URL: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
          MATTERMOST_CHANNEL: ${{ secrets.MATTERMOST_CHANNEL }}
          MATTERMOST_USERNAME: ${{ env.MATTERMOST_BOT_USERNAME }}
          TEXT: |
            AvArc Chatops Bot - Build failed! :x:
            [View build details](${{
              github.server_url }}/${{
              github.repository }}/actions/runs/${{
              github.run_id }})
